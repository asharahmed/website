#!/usr/bin/env bash
set -euo pipefail

if [ "${SKIP_HOOKS:-}" = "1" ]; then
  exit 0
fi

if [ "${SKIP_E2E:-}" = "1" ]; then
  exit 0
fi

if [ ! -f package.json ]; then
  exit 0
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "pre-push: npm not found; skipping."
  exit 0
fi

if command -v ldconfig >/dev/null 2>&1; then
  if ! ldconfig -p 2>/dev/null | grep -q "libatk-1.0.so.0"; then
    echo "pre-push: missing libatk; skipping e2e (run 'npx playwright install --with-deps')."
    exit 0
  fi
fi

if command -v pkill >/dev/null 2>&1; then
  pkill -f "http.server 4173" >/dev/null 2>&1 || true
fi

npm run -s test:e2e
